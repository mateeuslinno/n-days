`Vulnerability` : OOB 
`Patched In` : iOS 15.4 / macOS 12.3.1  
`Location` : AppleAVD.kext  
`Discovered By` : [Mickey Jin](https://twitter.com/patch1t)
`CVE ID` : [CVE-2022-22675](https://support.apple.com/en-us/HT213219)  
`Author` : [mateeuslinno](https://twitter.com/mateeuslinno)  

For start, this vulnerabilit isn't mine, I only realyzed a analysed based the fix apply by Apple.

Very thanks for Mickey Jin, for a trick, I caught the iOS kernel but Apple removed symbols because of that Mickek talked  me for I analyses the MacOSX kernel. 
Basiclly the vulnerability is a OOB (out of bounds again :)




```
com.apple.driver.AppleAVD:__text:FFFFFE000830BC84                 STP             X26, X25, [SP,#-0x10+var_40]!
com.apple.driver.AppleAVD:__text:FFFFFE000830BC88                 STP             X24, X23, [SP,#0x40+var_30]
com.apple.driver.AppleAVD:__text:FFFFFE000830BC8C                 STP             X22, X21, [SP,#0x40+var_20]
com.apple.driver.AppleAVD:__text:FFFFFE000830BC90                 STP             X20, X19, [SP,#0x40+var_10]
com.apple.driver.AppleAVD:__text:FFFFFE000830BC94                 STP             X29, X30, [SP,#0x40+var_s0]
com.apple.driver.AppleAVD:__text:FFFFFE000830BC98                 ADD             X29, SP, #0x40
com.apple.driver.AppleAVD:__text:FFFFFE000830BC9C                 MOV             X19, X1
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA0                 MOV             X20, X0
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA4                 LDR             W8, [X0,#0xC]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA8                 CLZ             W21, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BCAC                 CBZ             W21, loc_FFFFFE000830BCF0
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB0                 ADD             W1, W21, #1 ; int
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB4                 MOV             X0, X20 ; this
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB8                 MOV             W2, #0  ; bool
com.apple.driver.AppleAVD:__text:FFFFFE000830BCBC                 BL              __ZN8AVC_RBSP10flush_bitsEib ; AVC_RBSP::flush_bits(int,bool)
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC0                 LDR             W8, [X20,#0xC]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC4                 NEG             W9, W21
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC8                 LSR             W22, W8, W9
com.apple.driver.AppleAVD:__text:FFFFFE000830BCCC                 MOV             X0, X20 ; this
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD0                 MOV             X1, X21 ; int
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD4                 MOV             W2, #0  ; bool
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD8                 BL              __ZN8AVC_RBSP10flush_bitsEib ; AVC_RBSP::flush_bits(int,bool)
com.apple.driver.AppleAVD:__text:FFFFFE000830BCDC                 MOV             W8, #0xFFFFFFFF
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE0                 LSL             W8, W8, W21
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE4                 MVN             W8, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE8                 ADD             W8, W22, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BCEC                 B               loc_FFFFFE000830BD04
```

We can re-write: 
```
v4 = __clz(*((_DWORD *)this + 3));
  if ( v4 )
  {
    AVC_RBSP::flush_bits(this, v4 + 1, 0);
    v5 = *((_DWORD *)this + 3) >> -(char)v4;
    AVC_RBSP::flush_bits(this, v4, 0);
    v6 = v5 + ~(-1 << v4);
  }
 
      ```

If CLZ return between 0 and 9 the values can be: 
```
0
1
3
7
15
31
63
127
255
511
```
So it'll calculate this valuens as index in v5 
The fix the Apple maked a fix basiclly: 
```if v5[index] & 0xE0 != 0)```

We can see in asm of Kernel: 

```
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA0                 SUB             SP, SP, #0x60
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA4                 STP             X26, X25, [SP,#0x50+var_40]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCA8                 STP             X24, X23, [SP,#0x50+var_30]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCAC                 STP             X22, X21, [SP,#0x50+var_20]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB0                 STP             X20, X19, [SP,#0x50+var_10]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB4                 STP             X29, X30, [SP,#0x50+var_s0]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCB8                 ADD             X29, SP, #0x50
com.apple.driver.AppleAVD:__text:FFFFFE000830BCBC                 MOV             X19, X1
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC0                 MOV             X20, X0
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC4                 LDR             W8, [X0,#0xC]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCC8                 CLZ             W21, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BCCC                 CBZ             W21, loc_FFFFFE000830BD38
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD0                 ADD             W1, W21, #1 ; int
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD4                 MOV             X0, X20 ; this
com.apple.driver.AppleAVD:__text:FFFFFE000830BCD8                 MOV             W2, #0  ; bool
com.apple.driver.AppleAVD:__text:FFFFFE000830BCDC                 BL              __ZN8AVC_RBSP10flush_bitsEib ; AVC_RBSP::flush_bits(int,bool)
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE0                 LDR             W8, [X20,#0xC]
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE4                 NEG             W9, W21
com.apple.driver.AppleAVD:__text:FFFFFE000830BCE8                 LSR             W22, W8, W9
com.apple.driver.AppleAVD:__text:FFFFFE000830BCEC                 MOV             X0, X20 ; this
com.apple.driver.AppleAVD:__text:FFFFFE000830BCF0                 MOV             X1, X21 ; int
com.apple.driver.AppleAVD:__text:FFFFFE000830BCF4                 MOV             W2, #0  ; bool
com.apple.driver.AppleAVD:__text:FFFFFE000830BCF8                 BL              __ZN8AVC_RBSP10flush_bitsEib ; AVC_RBSP::flush_bits(int,bool)
com.apple.driver.AppleAVD:__text:FFFFFE000830BCFC                 MOV             W8, #0xFFFFFFFF
com.apple.driver.AppleAVD:__text:FFFFFE000830BD00                 LSL             W8, W8, W21
com.apple.driver.AppleAVD:__text:FFFFFE000830BD04                 MVN             W8, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BD08                 ADD             W8, W22, W8
com.apple.driver.AppleAVD:__text:FFFFFE000830BD0C                 STRB            W8, [X19]
com.apple.driver.AppleAVD:__text:FFFFFE000830BD10                 TST             W8, #0xE0 ------> 
com.apple.driver.AppleAVD:__text:FFFFFE000830BD14                 B.EQ            loc_FFFFFE000830BD4C -------->
com.apple.driver.AppleAVD:__text:FFFFFE000830BD18                 ADRL            X8, aHrdCpbCntMinus ; "hrd.cpb_cnt_minus1"
com.apple.driver.AppleAVD:__text:FFFFFE000830BD20                 STR             X8, [SP,#0x50+var_50]
com.apple.driver.AppleAVD:__text:FFFFFE000830BD24                 ADRL            X0, aErrorS ; "ERROR: %s \n"
com.apple.driver.AppleAVD:__text:FFFFFE000830BD2C                 BL              _SMDLog
com.apple.driver.AppleAVD:__text:FFFFFE000830BD30                 MOV             W0, #0xFFFFFFFF
com.apple.driver.AppleAVD:__text:FFFFFE000830BD34                 B               loc_FFFFFE000830BF0C
com.apple.driver.AppleAVD:__text:FFFFFE000830BD38 ; ------------------------------------------------------
```